#include "TTree.h"
#include "TFile.h"
#include "TChain.h"
#include "TROOT.h"
#include <iostream>

void addNewCentralityBin() {

  TFile *f = TFile::Open("skimmedEventTree.root");

  TTree *t = (TTree*)f->Get("hiEvtAnalyzer/HiTree");
  float hiHF; t->SetBranchAddress("hiHF", &hiHF);

  const unsigned int nbins = 200;
  //all data with 99% efficiency assumption
  //float bounds[nbins] = {0, 0,       4.04762, 7.94875, 8.87192, 9.63925, 10.352,  11.0471, 11.7421, 12.4473, 13.1628, 13.9033, 14.6723, 15.4741, 16.3079, 17.1722, 18.0754, 19.0186, 20.0083, 21.0433, 22.1173, 23.2456, 24.4197, 25.6465, 26.9281, 28.2597, 29.6468, 31.0998, 32.6157, 34.1829, 35.8173, 37.5099, 39.2764, 41.1233, 43.0289, 45.0194, 47.0861, 49.2282, 51.4504, 53.7763, 56.184,  58.6725, 61.275,  63.9771, 66.7814, 69.6963, 72.7096, 75.847,  79.1143, 82.4901, 85.9994, 89.6205, 93.3955, 97.2992, 101.365, 105.556, 109.886, 114.358, 118.997, 123.809, 128.756, 133.879, 139.191, 144.689, 150.373, 156.208, 162.271, 168.441, 174.82,  181.452, 188.269, 195.283, 202.513, 209.963, 217.615, 225.473, 233.638, 242.008, 250.578, 259.356, 268.421, 277.725, 287.268, 297.106, 307.108, 317.376, 327.935, 338.726, 349.82,  361.153, 372.816, 384.741, 396.957, 409.467, 422.243, 435.299, 448.712, 462.309, 476.299, 490.633, 505.261, 520.158, 535.446, 551.033, 566.856, 582.993, 599.573, 616.38,  633.661, 651.266, 669.184, 687.354, 705.962, 724.957, 744.331, 764.098, 784.154, 804.619, 825.561, 846.79,  868.365, 890.48,  912.804, 935.672, 958.81,  982.253, 1006.33, 1030.76, 1055.59, 1081.04, 1106.87, 1132.92, 1159.44, 1186.52, 1214.02, 1242.19, 1270.74, 1299.64, 1329.03, 1358.96, 1389.35, 1420.22, 1451.7,  1483.48, 1516.03, 1548.89, 1582.55, 1616.65, 1651.26, 1686.63, 1722.46, 1759.08, 1796.17, 1833.88, 1872.31, 1911.52, 1951.38, 1991.7,  2032.81, 2074.87, 2117.02, 2160.26, 2204.31, 2249.05, 2294.81, 2341.53, 2388.65, 2436.94, 2485.99, 2535.83, 2586.51, 2637.98, 2690.74, 2744.65, 2799.75, 2855.45, 2912.19, 2970.56, 3029.52, 3090.14, 3152.08, 3215.01, 3279.25, 3344.96, 3412.37, 3481.73, 3552.39, 3624.51, 3698.3,  3774.5,  3852.78, 3933.26, 4015.74, 4100.68, 4188.37, 4278.89, 4372.98, 4471.81, 4578.94, 4711.67};
  //Epos
  //float bounds[nbins] = {0, 2.72984, 2.98692, 3.25167, 3.61242, 4.06252, 4.56618, 5.14055, 5.70672, 6.32708, 6.9324,  7.56096, 8.20876, 8.88655, 9.59544, 10.3374, 11.0813, 11.9498, 12.8319, 13.6498, 14.5888, 15.5605, 16.6097, 17.7503, 18.9464, 20.2978, 21.6428, 23.0418, 24.5564, 26.1153, 27.8125, 29.4227, 31.2841, 33.2305, 35.443,  37.3632, 39.4451, 41.6987, 44.1925, 46.5716, 48.9,    51.3237, 53.988,  56.7292, 59.4536, 62.4428, 65.4692, 68.2821, 71.1936, 74.4321, 77.7686, 81.0463, 84.8161, 88.5267, 92.2663, 96.6656, 101.351, 105.285, 110.117, 114.816, 119.567, 124.529, 129.938, 135.671, 140.838, 146.703, 152.594, 158.517, 164.975, 171.343, 177.728, 184.546, 191.244, 198.446, 205.108, 213.316, 220.599, 228.315, 236.281, 244.342, 252.45,  261.633, 269.583, 279.559, 288.2,   297.737, 306.055, 315.983, 327.045, 337.749, 346.894, 358.48,  369.485, 381.664, 393.576, 405.478, 417.286, 430.413, 443.847, 459.049, 472.315, 487.009, 500.188, 515.293, 531.583, 544.335, 558.209, 573.449, 588.329, 605.822, 622.205, 640.538, 656.491, 671.834, 688.743, 706.301, 724.13,  742.685, 760.619, 778.073, 799.12,  819.481, 840.666, 862.68,  882.684, 904.961, 927.323, 949.152, 973.167, 997.165, 1019.45, 1041.74, 1065.03, 1090.72, 1119.97, 1147.18, 1174.32, 1201.02, 1227.46, 1257.01, 1285.99, 1318.23, 1349.45, 1380.86, 1417.6,  1449.57, 1482.72, 1519.54, 1553.7,  1589.98, 1627.66, 1666.3,  1703.92, 1740.4,  1772.18, 1814.64, 1855.89, 1899.62, 1940.76, 1986.66, 2031.36, 2074.46, 2123.35, 2175.54, 2227.21, 2279.54, 2329.45, 2384.78, 2439.72, 2497.71, 2552.48, 2613.1,  2670.02, 2731.11, 2791.89, 2851.2,  2915.49, 2980.99, 3051.15, 3118.76, 3186.04, 3260.17, 3337.62, 3423.49, 3500.23, 3578.98, 3660.17, 3743.73, 3830.48, 3920.57, 4026.55, 4129.73, 4225.15, 4337.4,  4449.95, 4569.9,  4693.32, 4841.35, 5002.22, 5222.89};
  //Hydjet Drum5Nv75
    float bounds[nbins] = {0, 2.88108, 3.24964, 3.67944, 4.097,   4.66811, 5.09503, 5.45162, 6.01967, 6.70332, 7.13774, 7.78658, 8.22974, 8.81022, 9.3683,  10.1493, 10.6179, 11.2773, 11.8806, 12.7595, 13.4569, 14.2453, 14.9821, 15.5856, 16.3672, 17.1667, 18.184,  19.1236, 19.9523, 21.0975, 22.3474, 23.3721, 24.6786, 25.8311, 27.2103, 28.6898, 30.6109, 32.5996, 34.2694, 36.5369, 37.9932, 39.8594, 41.4879, 43.7635, 46.6002, 48.9963, 51.2964, 55.0732, 57.7293, 60.2823, 63.2842, 67.4882, 70.2767, 73.4935, 76.8805, 81.2635, 85.0042, 89.0192, 93.0881, 97.7992, 101.987, 105.987, 110.481, 115.356, 120.356, 124.592, 130.168, 135.371, 141.029, 147.106, 153.388, 159.229, 165.711, 171.668, 177.951, 185.614, 192.615, 199.834, 205.638, 212.824, 220.561, 230.223, 237.837, 244.842, 254.068, 264.263, 275.432, 286.107, 295.636, 305.916, 314.58,  324.422, 335.405, 347.123, 359.667, 371.851, 382.697, 397.998, 409.58,  420.056, 431.985, 444.556, 460.069, 475.89,  487.123, 501.954, 519.304, 529.688, 544.444, 562.066, 579.333, 594.944, 610.349, 628.155, 645.427, 660.461, 678.342, 698.369, 717.617, 734.85,  750.74,  777.314, 799.682, 820.395, 839.451, 857.804, 877.52,  902.695, 921.707, 949.556, 969.122, 995.742, 1026.66, 1055.77, 1087.2,  1115.45, 1142.95, 1167.82, 1206.21, 1236.33, 1258.93, 1290.48, 1318.34, 1346.11, 1381.65, 1418.83, 1449.45, 1483.15, 1525.57, 1553.17, 1593.54, 1627.13, 1662.14, 1706.09, 1746.53, 1793.9,  1826.36, 1866.56, 1900.06, 1936.52, 1980.32, 2017.92, 2053.04, 2096.78, 2137.3,  2194.15, 2249.45, 2290.98, 2339.97, 2390.43, 2435.66, 2491.1,  2535.9,  2596.57, 2664.07, 2721.73, 2778.46, 2848.11, 2914.38, 2974.52, 3033.53, 3097.09, 3173.46, 3226.82, 3293.94, 3363.73, 3423.45, 3476.29, 3536.73, 3614.83, 3692.48, 3765.72, 3830.03, 3913.24, 4000.82, 4072.92, 4178.55, 4284.23, 4374.07, 4484.2};
  int newBin;

  TFile *fout = new TFile("skimmedEventTreeWithNewBin.root","recreate");
  fout->mkdir("hiEvtAnalyzer")->cd();
  TTree *tout = t->CloneTree(0);
  tout->Branch("newBin", &newBin, "newBin/I");

  for(int i=0; i<t->GetEntries(); i++) {

    t->GetEntry(i);
    if(i%1e6==0) cout << "Processing event " << i << endl;
    newBin = -1;
    for(unsigned int b = 0; b < nbins; ++b) {
      if(hiHF >= bounds[nbins-1-b]) {
	newBin = b;
	break;	    
      }
    }
    if(newBin<0) cout << "no new bin value found :(\n";
    tout->Fill();

  }

  tout->AutoSave();

  fout->Close();

}
