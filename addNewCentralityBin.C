#include "TTree.h"
#include "TFile.h"
#include "TChain.h"
#include "TROOT.h"
#include <iostream>

void addNewCentralityBin() {

  TFile *f = TFile::Open("skimmedEventTree.root");

  TTree *t = (TTree*)f->Get("hiEvtAnalyzer/HiTree");
  float hiHF; t->SetBranchAddress("hiHF", &hiHF);

  const unsigned int nbins = 200;
  //all data with 99% efficiency assumption
  float bounds[nbins] = {0, 0, 4.04762, 7.94875, 8.87192, 9.63925, 10.352, 11.0471, 11.7421, 12.4473, 13.1628, 13.9033, 14.6723, 15.4741, 16.3079, 17.1722, 18.0754, 19.0186, 20.0083, 21.0433, 22.1173, 23.2456, 24.4197, 25.6465, 26.9281, 28.2597, 29.6468, 31.0998, 32.6157, 34.1829, 35.8173, 37.5099, 39.2764, 41.1233, 43.0289, 45.0194, 47.0861, 49.2282, 51.4504, 53.7763, 56.184, 58.6725, 61.275, 63.9771, 66.7814, 69.6963, 72.7096, 75.847, 79.1143, 82.4901, 85.9994, 89.6205, 93.3955, 97.2992, 101.365, 105.556, 109.886, 114.358, 118.997, 123.809, 128.756, 133.879, 139.191, 144.689, 150.373, 156.208, 162.271, 168.441, 174.82, 181.452, 188.269, 195.283, 202.513, 209.963, 217.615, 225.473, 233.638, 242.008, 250.578, 259.356, 268.421, 277.725, 287.268, 297.106, 307.108, 317.376, 327.935, 338.726, 349.82, 361.153, 372.816, 384.741, 396.957, 409.467, 422.243, 435.299, 448.712, 462.309, 476.299, 490.633, 505.261, 520.158, 535.446, 551.033, 566.856, 582.993, 599.573, 616.38, 633.661, 651.266, 669.184, 687.354, 705.962, 724.957, 744.331, 764.098, 784.154, 804.619, 825.561, 846.79, 868.365, 890.48, 912.804, 935.672, 958.81, 982.253, 1006.33, 1030.76, 1055.59, 1081.04, 1106.87, 1132.92, 1159.44, 1186.52, 1214.02, 1242.19, 1270.74, 1299.64, 1329.03, 1358.96, 1389.35, 1420.22, 1451.7, 1483.48, 1516.03, 1548.89, 1582.55, 1616.65, 1651.26, 1686.63, 1722.46, 1759.08, 1796.17, 1833.88, 1872.31, 1911.52, 1951.38, 1991.7, 2032.81, 2074.87, 2117.02, 2160.26, 2204.31, 2249.05, 2294.81, 2341.53, 2388.65, 2436.94, 2485.99, 2535.83, 2586.51, 2637.98, 2690.74, 2744.65, 2799.75, 2855.45, 2912.19, 2970.56, 3029.52, 3090.14, 3152.08, 3215.01, 3279.25, 3344.96, 3412.37, 3481.73, 3552.39, 3624.51, 3698.3, 3774.5, 3852.78, 3933.26, 4015.74, 4100.68, 4188.37, 4278.89, 4372.98, 4471.81, 4578.94, 4711.67};
  //other binnings can come here
  //...
  int newBin;

  TFile *fout = new TFile("skimmedEventTreeWithNewBin.root","recreate");
  fout->mkdir("hiEvtAnalyzer")->cd();
  TTree *tout = t->CloneTree(0);
  tout->Branch("newBin", &newBin, "newBin/I");

  for(int i=0; i<t->GetEntries(); i++) {

    t->GetEntry(i);
    if(i%1e6==0) cout << "Processing event " << i << endl;
    newBin = -1;
    for(unsigned int b = 0; b < nbins; ++b) {
      if(hiHF >= bounds[nbins-1-b]) {
	newBin = b;
	break;	    
      }
    }
    if(newBin<0) cout << "no new bin value found :(\n";
    tout->Fill();

  }

  tout->AutoSave();

  fout->Close();

}
